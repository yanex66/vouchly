{% extends 'core/base.html' %}

{% block content %}
<style>
    :root {
        --vouchly-blue: #002060;
        --vouchly-gold: #ffc107;
        --soft-bg: #f8f9fa;
        --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    body { background-color: var(--soft-bg); }
    .dash-nav .nav-link {
        color: #495057; font-weight: 600; padding: 0.8rem 1rem; border-radius: 10px; transition: 0.3s; display: flex; align-items: center;
    }
    .dash-nav .nav-link i { margin-right: 12px; font-size: 1.2rem; }
    .dash-nav .nav-link:hover, .dash-nav .nav-link.active {
        background-color: rgba(0, 32, 96, 0.05); color: var(--vouchly-blue);
    }
    .dash-nav .nav-link.active { border-left: 4px solid var(--vouchly-blue); }
    .stat-card { background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 1.5rem; height: 100%; box-shadow: var(--card-shadow); }
    .stat-val { font-size: 1.75rem; font-weight: 800; color: var(--vouchly-blue); }
    .stat-label { font-size: 0.85rem; color: #6c757d; font-weight: 700; text-transform: uppercase; }
    .balance-box { background: white; border-radius: 12px; padding: 2rem; border: 1px solid #e9ecef; box-shadow: var(--card-shadow); }
</style>

<div class="container py-4 mt-2">
    <div class="row">
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm p-3 rounded-4 mb-4">
                <nav class="nav flex-column dash-nav">
                    <a class="nav-link active" href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Dashboard</a>
                    <a class="nav-link" href="{% url 'referrals' %}"><i class="bi bi-people"></i> Refer & Earn</a>
                    <a class="nav-link" href="{% url 'edit_profile' %}"><i class="bi bi-person-gear"></i> Settings</a>
                    <a class="nav-link" href="{% url 'request_payout' %}"><i class="bi bi-wallet2"></i> Payments</a>
                    <a class="nav-link text-danger mt-3" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a>
                </nav>
            </div>
        </div>

        <div class="col-lg-9">
            <h3 class="fw-bold mb-4">Affiliate Dashboard</h3>

            <div class="row g-4 mb-4">
                <div class="col-md-12">
                    <div class="balance-box">
                        <span class="stat-label d-block mb-2 text-primary">Your Invite Link</span>
                        <div class="input-group">
                            <input type="text" class="form-control bg-light" id="affLink" value="{{ request.scheme }}://{{ request.get_host }}{% url 'register' %}?ref={{ user.username }}" readonly>
                            <button class="btn btn-primary px-4" onclick="copyToClipboard('affLink')">Copy Link</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4 text-center">
                <div class="col-6 col-md-4">
                    <div class="stat-card border-primary">
                        <span class="stat-label text-primary">Wallet Balance</span>
                        <div class="stat-val mt-2">₦{{ user.profile.balance|floatformat:0 }}</div>
                        <span class="small text-muted fw-bold">Spendable Cash</span>
                    </div>
                </div>

                <div class="col-6 col-md-4">
                    <div class="stat-card border-success">
                        <span class="stat-label text-success">Lifetime Total</span>
                        <div class="stat-val mt-2">₦{{ lifetime_total|floatformat:0 }}</div>
                        <span class="stat-growth bg-success-subtle text-success mt-2 d-inline-block px-2 rounded-pill small">Total Earned</span>
                    </div>
                </div>

                <div class="col-12 col-md-4">
                    <div class="stat-card">
                        <span class="stat-label">Pending VOCOIN</span>
                        <div class="stat-val mt-2">{{ vocoin_balance }}</div>
                        <a href="{% url 'redeem_tokens' %}" class="btn btn-sm btn-warning mt-2 fw-bold rounded-pill px-3 shadow-sm">Redeem to Wallet</a>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0">Friends Invited</h5>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Username</th>
                                <th class="text-center">Joined Date</th>
                                <th class="text-end pe-4">Reward</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ref in my_referrals %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ ref.referred_user.username }}</td>
                                <td class="text-center small text-muted">{{ ref.created_at|date:"M d, Y" }}</td>
                                <td class="text-end pe-4">
                                    <span class="badge bg-success-subtle text-success rounded-pill px-3">+1 VOCOIN</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center py-5 text-muted">No friends invited yet.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0">Transaction History</h5>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Date</th>
                                <th class="text-center">Amount</th>
                                <th class="text-end pe-4">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payout in my_payouts %}
                            <tr>
                                <td class="ps-4 small">
                                    <div class="fw-bold text-dark">{{ payout.created_at|date:"M d, Y" }}</div>
                                    <div class="text-muted small">
                                        {% if payout.status == 'PAID' %}Internal Redemption{% else %}Bank Payout{% endif %}
                                    </div>
                                </td>
                                <td class="text-center fw-bold text-primary">₦{{ payout.amount|floatformat:2 }}</td>
                                <td class="text-end pe-4">
                                    {% if payout.status == 'PAID' %}
                                        <span class="badge bg-success rounded-pill px-3">Completed</span>
                                    {% elif payout.status == 'PENDING' %}
                                        <span class="badge bg-warning text-dark rounded-pill px-3">Pending</span>
                                    {% else %}
                                        <span class="badge bg-danger rounded-pill px-3">{{ payout.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center py-5 text-muted">No transactions found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(id) {
        const el = document.getElementById(id);
        el.select();
        navigator.clipboard.writeText(el.value).then(() => {
            const btn = document.querySelector('[onclick="copyToClipboard(\'affLink\')"]');
            btn.innerText = "Copied!";
            setTimeout(() => { btn.innerText = "Copy Link"; }, 2000);
        });
    }
</script>
{% endblock %}